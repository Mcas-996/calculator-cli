# GitLab CI/CD configuration for calculator-cli npm package

stages:
  - test
  - build
  - publish

variables:
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  CARGO_TERM_COLOR: "always"

# Cache Rust dependencies
cache:
  paths:
    - .cargo/
    - target/
  key: "$CI_JOB_NAME"

# Test stage - runs on all commits
test:
  stage: test
  image: node:18
  script:
    - echo "Testing package structure..."
    - node test-package.js
    - echo "Package structure validation complete."
  only:
    - merge_requests
    - main

# Build stage - creates binaries for specific platforms
build-linux:
  stage: build
  image: rust:latest
  variables:
    TARGET: "x86_64-unknown-linux-gnu"
    BINARY_NAME: "calculator-linux-x64"
  script:
    - echo "Building for Linux x64..."
    - rustup target add $TARGET
    - cargo build --release --target $TARGET
    - mkdir -p bin
    - cp target/$TARGET/release/calculator bin/$BINARY_NAME
    - echo "Linux x64 binary built successfully."
  artifacts:
    paths:
      - bin/calculator-linux-x64
    expire_in: 1 week
  only:
    - tags

build-macos:
  stage: build
  tags:
    - macos
  variables:
    TARGET: "x86_64-apple-darwin"
    BINARY_NAME: "calculator-darwin-x64"
  script:
    - echo "Building for macOS x64..."
    - rustup target add $TARGET
    - cargo build --release --target $TARGET
    - mkdir -p bin
    - cp target/$TARGET/release/calculator bin/$BINARY_NAME
    - echo "macOS x64 binary built successfully."
  artifacts:
    paths:
      - bin/calculator-darwin-x64
    expire_in: 1 week
  only:
    - tags

build-windows:
  stage: build
  tags:
    - windows
  variables:
    TARGET: "x86_64-pc-windows-msvc"
    BINARY_NAME: "calculator-win32-x64.exe"
  script:
    - echo "Building for Windows x64..."
    - rustup target add $TARGET
    - cargo build --release --target $TARGET
    - mkdir -p bin
    - cp target/$TARGET/release/calculator.exe bin/$BINARY_NAME
    - echo "Windows x64 binary built successfully."
  artifacts:
    paths:
      - bin/calculator-win32-x64.exe
    expire_in: 1 week
  only:
    - tags

# Publish stage - assembles package and publishes to npm
publish:
  stage: publish
  image: node:18
  needs:
    - build-linux
    - build-macos
    - build-windows
  before_script:
    - echo "Setting up npm credentials..."
    - npm config set //registry.npmjs.org/:_authToken ${NPM_TOKEN}
  script:
    - echo "Downloading all binaries..."
    - echo "Preparing npm package..."
    - mkdir -p bin

    # Extract version from tag
    - export VERSION=${CI_COMMIT_TAG#v}
    - echo "Version: $VERSION"

    # Update package.json version to match tag
    - npm version $VERSION --no-git-tag-version

    # Verify all binaries are present
    - test -f bin/calculator-linux-x64 || (echo "Linux binary missing" && exit 1)
    - test -f bin/calculator-darwin-x64 || (echo "macOS binary missing" && exit 1)
    - test -f bin/calculator-win32-x64.exe || (echo "Windows binary missing" && exit 1)

    # Publish to npm
    - echo "Publishing to npm..."
    - npm publish --access public
    - echo "Published to npm successfully!"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/  # Only on version tags like v1.2.3
  variables:
    NPM_TOKEN: $NPM_TOKEN  # Set this in GitLab CI/CD variables
